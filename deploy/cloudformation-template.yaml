AWSTemplateFormatVersion: '2010-09-09'
Description: 'Marketing Frontend - Next.js Application on ECS Fargate'

Parameters:
  EnvironmentName:
    Type: String
    Default: production
    Description: Environment name (e.g., production, staging, development)
    AllowedValues:
      - production
      - staging
      - development

  ExistingVpcId:
    Type: AWS::EC2::VPC::Id
    Description: Existing VPC ID (required - use the same VPC as your backend)

  ExistingPublicSubnet1Id:
    Type: AWS::EC2::Subnet::Id
    Description: Existing public subnet 1 ID (required - use the same subnets as your backend)

  ExistingPublicSubnet2Id:
    Type: AWS::EC2::Subnet::Id
    Description: Existing public subnet 2 ID (required)

  ExistingPublicSubnet3Id:
    Type: AWS::EC2::Subnet::Id
    Default: ''
    Description: Existing public subnet 3 ID (optional - provide for 3 AZ deployment)

  ContainerImage:
    Type: String
    Description: Docker image URI (e.g., 123456789.dkr.ecr.us-east-1.amazonaws.com/marketing-frontend:latest or docker.arthur.ai/arthur/marketing-tool/marketing-frontend:latest)

  DockerRegistryUsername:
    Type: String
    Default: ''
    Description: Docker registry username (required for private registries like docker.arthur.ai, leave empty for ECR)
    NoEcho: true

  DockerRegistryPassword:
    Type: String
    Default: ''
    Description: Docker registry password (required for private registries like docker.arthur.ai, leave empty for ECR)
    NoEcho: true

  ContainerPort:
    Type: Number
    Default: 3000
    Description: Port the container listens on

  TaskCPU:
    Type: String
    Default: '512'
    Description: CPU units for the task (256, 512, 1024, 2048, 4096)

  TaskMemory:
    Type: String
    Default: '1024'
    Description: Memory for the task in MB (512, 1024, 2048, 4096, 8192)

  DesiredCount:
    Type: Number
    Default: 2
    Description: Number of tasks to run

  MinCount:
    Type: Number
    Default: 1
    Description: Minimum number of tasks for auto-scaling

  MaxCount:
    Type: Number
    Default: 10
    Description: Maximum number of tasks for auto-scaling

  BackendApiUrl:
    Type: String
    Description: Backend API base URL (e.g., https://api.example.com)

  BackendWebSocketUrl:
    Type: String
    Description: Backend WebSocket URL (e.g., wss://api.example.com)

  CertificateArn:
    Type: String
    Default: ''
    Description: ACM Certificate ARN for HTTPS (optional, leave empty for HTTP only)

  DomainName:
    Type: String
    Default: ''
    Description: Domain name for Route53 (optional)

  HostedZoneId:
    Type: String
    Default: ''
    Description: Route53 Hosted Zone ID (optional)

Conditions:
  HasCertificate: !Not [!Equals [!Ref CertificateArn, '']]
  HasDomain: !Not [!Equals [!Ref DomainName, '']]
  HasDockerRegistryCredentials: !And
    - !Not [!Equals [!Ref DockerRegistryUsername, '']]
    - !Not [!Equals [!Ref DockerRegistryPassword, '']]
  HasThirdSubnet: !Not [!Equals [!Ref ExistingPublicSubnet3Id, '']]

Resources:
  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-marketing-frontend-alb-sg'
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref ExistingVpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - !If
          - HasCertificate
          - IpProtocol: tcp
            FromPort: 443
            ToPort: 443
            CidrIp: 0.0.0.0/0
          - !Ref AWS::NoValue
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-alb-sg'

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${EnvironmentName}-marketing-frontend-ecs-sg'
      GroupDescription: Security group for ECS tasks
      VpcId: !Ref ExistingVpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-ecs-sg'

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${EnvironmentName}-frontend-alb'
      Subnets: !If
        - HasThirdSubnet
        - - !Ref ExistingPublicSubnet1Id
          - !Ref ExistingPublicSubnet2Id
          - !Ref ExistingPublicSubnet3Id
        - - !Ref ExistingPublicSubnet1Id
          - !Ref ExistingPublicSubnet2Id
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-alb'

  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub '${EnvironmentName}-frontend-tg'
      Port: !Ref ContainerPort
      Protocol: HTTP
      VpcId: !Ref ExistingVpcId
      TargetType: ip
      HealthCheckEnabled: true
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Matcher:
        HttpCode: 200-399
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-tg'

  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: !If [HasCertificate, 443, 80]
      Protocol: !If [HasCertificate, HTTPS, HTTP]
      Certificates:
        - !If
          - HasCertificate
          - CertificateArn: !Ref CertificateArn
          - !Ref AWS::NoValue
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref ALBTargetGroup

  HTTPRedirectListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: HasCertificate
    Properties:
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${EnvironmentName}-marketing-frontend-cluster'
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-cluster'

  # CloudWatch Logs
  ECSLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/ecs/${EnvironmentName}-marketing-frontend'
      RetentionInDays: 30

  # Docker Registry Secret (if credentials provided)
  DockerRegistrySecret:
    Type: AWS::SecretsManager::Secret
    Condition: HasDockerRegistryCredentials
    Properties:
      Name: !Sub '${EnvironmentName}-marketing-frontend-docker-registry-credentials'
      Description: Docker registry credentials for frontend image pull
      SecretString: !Sub |
        {
          "username": "${DockerRegistryUsername}",
          "password": "${DockerRegistryPassword}"
        }

  # ECS Task Execution Role
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - !If
          - HasDockerRegistryCredentials
          - PolicyName: SecretsManagerAccess
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - secretsmanager:GetSecretValue
                  Resource: !Ref DockerRegistrySecret
          - !Ref AWS::NoValue
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-execution-role'

  # ECS Task Role
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-task-role'

  # ECS Task Definition
  TaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub '${EnvironmentName}-marketing-frontend'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: !Ref TaskCPU
      Memory: !Ref TaskMemory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: marketing-frontend
          Image: !Ref ContainerImage
          RepositoryCredentials: !If
            - HasDockerRegistryCredentials
            - CredentialsParameter: !Ref DockerRegistrySecret
            - !Ref AWS::NoValue
          PortMappings:
            - ContainerPort: !Ref ContainerPort
              Protocol: tcp
          Environment:
            - Name: NODE_ENV
              Value: !Ref EnvironmentName
            - Name: NEXT_PUBLIC_BACKEND_API_BASE_URL
              Value: !Ref BackendApiUrl
            - Name: NEXT_PUBLIC_BACKEND_WEBSOCKET_URL
              Value: !Ref BackendWebSocketUrl
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ECSLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  # ECS Service
  ECSService:
    Type: AWS::ECS::Service
    DependsOn: ALBListener
    Properties:
      ServiceName: !Sub '${EnvironmentName}-marketing-frontend-service'
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref TaskDefinition
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref ECSSecurityGroup
          Subnets: !If
            - HasThirdSubnet
            - - !Ref ExistingPublicSubnet1Id
              - !Ref ExistingPublicSubnet2Id
              - !Ref ExistingPublicSubnet3Id
            - - !Ref ExistingPublicSubnet1Id
              - !Ref ExistingPublicSubnet2Id
      LoadBalancers:
        - ContainerName: marketing-frontend
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref ALBTargetGroup
      HealthCheckGracePeriodSeconds: 60
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-marketing-frontend-service'

  # Auto Scaling
  ServiceScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref MaxCount
      MinCapacity: !Ref MinCount
      ResourceId: !Sub 'service/${ECSCluster}/${ECSService.Name}'
      RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService'
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  ServiceScalingPolicyCPU:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${EnvironmentName}-frontend-cpu-scaling'
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ServiceScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 70.0
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization

  ServiceScalingPolicyMemory:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub '${EnvironmentName}-frontend-memory-scaling'
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref ServiceScalingTarget
      TargetTrackingScalingPolicyConfiguration:
        TargetValue: 80.0
        ScaleInCooldown: 60
        ScaleOutCooldown: 60
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageMemoryUtilization

  # Route53 DNS Record (Optional)
  DNSRecord:
    Type: AWS::Route53::RecordSet
    Condition: HasDomain
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName

Outputs:
  LoadBalancerURL:
    Description: URL of the Application Load Balancer
    Value: !Sub 
      - '${Protocol}://${DNSName}'
      - Protocol: !If [HasCertificate, 'https', 'http']
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${EnvironmentName}-marketing-frontend-url'

  LoadBalancerDNS:
    Description: DNS name of the Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${EnvironmentName}-marketing-frontend-alb-dns'

  ECSClusterName:
    Description: Name of the ECS Cluster
    Value: !Ref ECSCluster
    Export:
      Name: !Sub '${EnvironmentName}-marketing-frontend-cluster-name'

  ECSServiceName:
    Description: Name of the ECS Service
    Value: !GetAtt ECSService.Name
    Export:
      Name: !Sub '${EnvironmentName}-marketing-frontend-service-name'

  VPCId:
    Description: VPC ID
    Value: !Ref ExistingVpcId
    Export:
      Name: !Sub '${EnvironmentName}-marketing-frontend-vpc-id'

  WebsiteURL:
    Description: Website URL
    Value: !If
      - HasDomain
      - !Sub 
        - '${Protocol}://${Domain}'
        - Protocol: !If [HasCertificate, 'https', 'http']
          Domain: !Ref DomainName
      - !Sub 
        - '${Protocol}://${DNSName}'
        - Protocol: !If [HasCertificate, 'https', 'http']
          DNSName: !GetAtt ApplicationLoadBalancer.DNSName











